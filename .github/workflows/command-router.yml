# ============================================================================
# Command Router â€” GitClaw's nerve center
# Routes slash commands from issue comments to the right agent.
# Triggered by: /research, /lore, /roast, /help
# ============================================================================
name: "ğŸ¦ Command Router"

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write

jobs:
  route:
    # Only run on comments that start with /
    if: startsWith(github.event.comment.body, '/')
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      args: ${{ steps.parse.outputs.args }}

    steps:
      - name: Parse command
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          COMMAND=$(echo "$COMMENT_BODY" | head -1 | awk '{print $1}' | tr -d '/')
          ARGS=$(echo "$COMMENT_BODY" | head -1 | sed 's|^/[a-zA-Z_-]* *||')
          echo "command=$COMMAND" >> "$GITHUB_OUTPUT"
          echo "args=$ARGS" >> "$GITHUB_OUTPUT"
          echo "Parsed command: /$COMMAND with args: $ARGS"

      - name: React to acknowledge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content='eyes' || true

  # â”€â”€â”€ Research Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  research:
    needs: route
    if: needs.route.outputs.command == 'research'
    uses: ./.github/workflows/wild-fact-finder.yml
    with:
      topic: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Lore Keeper Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lore:
    needs: route
    if: needs.route.outputs.command == 'lore'
    uses: ./.github/workflows/lore-keeper.yml
    with:
      topic: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Code Jester â€” Roast Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  roast:
    needs: route
    if: needs.route.outputs.command == 'roast'
    uses: ./.github/workflows/code-jester.yml
    with:
      target: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
      mode: roast
    secrets: inherit

  # â”€â”€â”€ HN Scraper Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  hn:
    needs: route
    if: needs.route.outputs.command == 'hn'
    uses: ./.github/workflows/hn-scraper.yml
    with:
      query_args: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ News Scraper Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  news:
    needs: route
    if: needs.route.outputs.command == 'news'
    uses: ./.github/workflows/news-scraper.yml
    with:
      query_args: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Crypto Quant Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  crypto:
    needs: route
    if: needs.route.outputs.command == 'crypto'
    uses: ./.github/workflows/crypto-quant.yml
    with:
      query_args: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Stock Quant Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  stock:
    needs: route
    if: needs.route.outputs.command == 'stock'
    uses: ./.github/workflows/stock-quant.yml
    with:
      query_args: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Solana Query Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sol:
    needs: route
    if: needs.route.outputs.command == 'sol'
    uses: ./.github/workflows/solana-query.yml
    with:
      query_args: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Solana Builder Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-sbf:
    needs: route
    if: needs.route.outputs.command == 'build-sbf'
    uses: ./.github/workflows/solana-builder.yml
    with:
      program_path: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Karen QA Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  karen:
    needs: route
    if: needs.route.outputs.command == 'karen'
    uses: ./.github/workflows/karen.yml
    with:
      query_args: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Architect Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  propose:
    needs: route
    if: needs.route.outputs.command == 'propose'
    uses: ./.github/workflows/architect.yml
    with:
      proposal_context: ${{ needs.route.outputs.args }}
      issue_number: ${{ github.event.issue.number }}
    secrets: inherit

  # â”€â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  help:
    needs: route
    if: needs.route.outputs.command == 'help'
    runs-on: ubuntu-latest
    steps:
      - name: Post help message
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HELP_MSG=$(cat <<'HELP'
          ## ğŸ¦ GitClaw Commands

          | Command | Agent | Description |
          |---------|-------|-------------|
          | `/research <topic>` | ğŸ” Wild Fact Finder | Research any topic with entertaining flair |
          | `/lore <topic>` | ğŸ“œ Lore Keeper | Add an entry to the repo's knowledge chronicles |
          | `/roast <file_or_topic>` | ğŸƒ Code Jester | Get a brutally honest code roast |
          | `/propose [hint]` | ğŸ—ï¸ Architect | Propose a code improvement PR |
          | `/karen` | ğŸ’… Karen | QA audit â€” find bugs, empty values, broken things |
          | `/help` | ğŸ¦ GitClaw | Show this help message |

          **Market & News Plugin** (enable in agent.md):
          | `/hn [top\|search <term>\|trending]` | ğŸ“° HN Scraper | Hacker News stories with hype scores |
          | `/news <topic>` | ğŸ¥· News Scraper | Global news analysis with ninja flair |
          | `/crypto <coin>` | ğŸ”® Crypto Oracle | Crypto quant analysis (RSI, SMA, vol) |
          | `/stock <ticker>` | ğŸ§™ Stock Wizard | Stock quant analysis with wizard magic |

          **Solana Plugin** (enable with `enable: solana` in agent.md):
          | `/sol price <token>` | ğŸŒ Solana Query | Check token price via Dexscreener |
          | `/sol balance <addr>` | ğŸŒ Solana Query | Check wallet SOL balance |
          | `/sol quote <from> <to> <amt>` | ğŸŒ Solana Query | Get Jupiter swap quote |
          | `/sol network` | ğŸŒ Solana Query | Solana network status |
          | `/build-sbf [path]` | ğŸ”¨ Solana Builder | Build a Solana program |

          **Automatic Agents** (no command needed):
          - â˜• **Morning Roast** â€” Daily issue digest + fortune (weekdays 9 AM UTC)
          - âš”ï¸ **Quest Master** â€” Auto-gamifies new issues
          - ğŸƒ **Code Jester** â€” Auto-reviews PRs + `/roast` mode
          - ğŸ‰ **Hype Man** â€” Celebrates closed issues/merged PRs
          - ğŸ“° **HN Scraper** â€” Daily HN digest (7 AM UTC, if enabled)
          - ğŸ¥· **News Scraper** â€” Daily news briefing (7:30 AM UTC, if enabled)
          - ğŸ“¡ **Solana Monitor** â€” Wallet & price monitoring (if enabled)

          **Architect & Council Plugin** (enable in agent.md):
          | `/propose [hint]` | ğŸ—ï¸ Architect | Propose a code improvement PR |
          - ğŸ’… **Karen** â€” Weekly QA audit + PR review (Mondays 5 AM UTC, if enabled)
          - ğŸ—ï¸ **Architect** â€” Daily autonomous improvement proposals (6 AM UTC, if enabled)
          - âš–ï¸ **Council of 7** â€” Auto-reviews Architect PRs with 7 persona voters
          - ğŸ“º **Pages Builder** â€” Rebuilds Bloomberg-terminal site (every 4h, if enabled)

          *â€” ğŸ¦ GitClaw, at your service*
          HELP
          )

          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="$HELP_MSG"
